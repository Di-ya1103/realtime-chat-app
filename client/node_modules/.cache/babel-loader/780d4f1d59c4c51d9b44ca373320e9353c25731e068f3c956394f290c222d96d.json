{"ast":null,"code":"import express from 'express';\nimport http from 'http';\nimport mongoose from 'mongoose';\nimport { Server } from 'socket.io';\nimport cors from 'cors';\nimport dotenv from 'dotenv';\nimport authRoutes from './routes/auth.js';\nimport messageRoutes from './routes/messages.js';\nimport User from './models/User.js';\nimport Message from './models/Message.js';\ndotenv.config();\n\n// Fix Mongoose strictQuery deprecation warning\nmongoose.set('strictQuery', true);\nconsole.log('Loaded environment variables:', process.env);\nconst app = express();\nconst server = http.createServer(app);\nconst io = new Server(server, {\n  cors: {\n    origin: 'http://localhost:3000'\n  }\n});\napp.use(cors({\n  origin: 'http://localhost:3000'\n}));\napp.use(express.json());\n\n// Optional root route for testing\napp.get('/', (req, res) => res.send('Server is running!'));\napp.get('/favicon.ico', (req, res) => res.status(204).end());\napp.use('/api/auth', authRoutes);\napp.use('/api/messages', messageRoutes);\nif (!process.env.MONGO_URI) {\n  console.error('Error: MONGO_URI is not defined in .env file');\n  process.exit(1);\n}\nmongoose.connect(process.env.MONGO_URI, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true,\n  serverSelectionTimeoutMS: 30000,\n  socketTimeoutMS: 45000\n}).then(() => console.log('MongoDB connected successfully')).catch(err => {\n  console.error('MongoDB connection error:', err.message || err);\n  process.exit(1);\n});\nconst onlineUsers = new Map();\nio.on('connection', socket => {\n  console.log('New socket connection:', socket.id);\n  socket.on('user:connect', async user => {\n    if (!(user !== null && user !== void 0 && user._id)) {\n      console.log('Invalid user ID in user:connect:', user);\n      return;\n    }\n    try {\n      onlineUsers.set(user._id, socket.id);\n      await User.findByIdAndUpdate(user._id, {\n        online: true\n      });\n      io.emit('update:users', Array.from(onlineUsers.keys()));\n      console.log('User connected:', user._id, 'Online users:', Array.from(onlineUsers.entries()));\n    } catch (err) {\n      console.error('Error updating user online status:', err.message || err);\n    }\n  });\n  socket.on('send:message', async msg => {\n    console.log('Received message event with data:', msg);\n    try {\n      if (!msg.sender || !msg.receiver || !msg.text) {\n        console.log('Invalid message data:', msg);\n        return;\n      }\n      console.log('Attempting to create message with:', {\n        sender: msg.sender,\n        receiver: msg.receiver,\n        text: msg.text\n      });\n      const newMessage = await Message.create({\n        sender: mongoose.Types.ObjectId.createFromHexString(msg.sender),\n        receiver: mongoose.Types.ObjectId.createFromHexString(msg.receiver),\n        text: msg.text,\n        timestamp: msg.timestamp || new Date()\n      });\n      const populatedMessage = await Message.findById(newMessage._id).populate('sender', 'username').populate('receiver', 'username');\n      const receiverSocket = onlineUsers.get(msg.receiver);\n      if (receiverSocket) {\n        io.to(receiverSocket).emit('receive:message', populatedMessage);\n        console.log('Message sent to receiver:', receiverSocket);\n      }\n      io.to(socket.id).emit('receive:message', populatedMessage);\n      console.log('Message sent to sender, data:', populatedMessage);\n    } catch (err) {\n      console.error('Error sending message:', err.message || err);\n    }\n  });\n  socket.on('disconnect', async () => {\n    console.log('Socket disconnecting:', socket.id);\n    for (const [userId, sId] of onlineUsers.entries()) {\n      if (sId === socket.id) {\n        onlineUsers.delete(userId);\n        try {\n          await User.findByIdAndUpdate(userId, {\n            online: false\n          });\n          io.emit('update:users', Array.from(onlineUsers.keys()));\n          console.log('User disconnected:', userId, 'Online users:', Array.from(onlineUsers.entries()));\n        } catch (err) {\n          console.error('Error updating user offline status:', err.message || err);\n        }\n        break;\n      }\n    }\n  });\n});\nconst PORT = process.env.PORT || 5000;\nserver.listen(PORT, () => console.log(`Server running on port ${PORT}`));","map":{"version":3,"names":["express","http","mongoose","Server","cors","dotenv","authRoutes","messageRoutes","User","Message","config","set","console","log","process","env","app","server","createServer","io","origin","use","json","get","req","res","send","status","end","MONGO_URI","error","exit","connect","useNewUrlParser","useUnifiedTopology","serverSelectionTimeoutMS","socketTimeoutMS","then","catch","err","message","onlineUsers","Map","on","socket","id","user","_id","findByIdAndUpdate","online","emit","Array","from","keys","entries","msg","sender","receiver","text","newMessage","create","Types","ObjectId","createFromHexString","timestamp","Date","populatedMessage","findById","populate","receiverSocket","to","userId","sId","delete","PORT","listen"],"sources":["C:/Users/Diya/Documents/realtime-chat-app/client/src/index.js"],"sourcesContent":["import express from 'express';\r\nimport http from 'http';\r\nimport mongoose from 'mongoose';\r\nimport { Server } from 'socket.io';\r\nimport cors from 'cors';\r\nimport dotenv from 'dotenv';\r\nimport authRoutes from './routes/auth.js';\r\nimport messageRoutes from './routes/messages.js';\r\nimport User from './models/User.js';\r\nimport Message from './models/Message.js';\r\n\r\ndotenv.config();\r\n\r\n// Fix Mongoose strictQuery deprecation warning\r\nmongoose.set('strictQuery', true);\r\n\r\nconsole.log('Loaded environment variables:', process.env);\r\n\r\nconst app = express();\r\nconst server = http.createServer(app);\r\nconst io = new Server(server, {\r\n  cors: { origin: 'http://localhost:3000' },\r\n});\r\n\r\napp.use(cors({ origin: 'http://localhost:3000' }));\r\napp.use(express.json());\r\n\r\n// Optional root route for testing\r\napp.get('/', (req, res) => res.send('Server is running!'));\r\n\r\napp.get('/favicon.ico', (req, res) => res.status(204).end());\r\n\r\napp.use('/api/auth', authRoutes);\r\napp.use('/api/messages', messageRoutes);\r\n\r\nif (!process.env.MONGO_URI) {\r\n  console.error('Error: MONGO_URI is not defined in .env file');\r\n  process.exit(1);\r\n}\r\n\r\nmongoose.connect(process.env.MONGO_URI, {\r\n  useNewUrlParser: true,\r\n  useUnifiedTopology: true,\r\n  serverSelectionTimeoutMS: 30000,\r\n  socketTimeoutMS: 45000,\r\n})\r\n  .then(() => console.log('MongoDB connected successfully'))\r\n  .catch((err) => {\r\n    console.error('MongoDB connection error:', err.message || err);\r\n    process.exit(1);\r\n  });\r\n\r\nconst onlineUsers = new Map();\r\n\r\nio.on('connection', (socket) => {\r\n  console.log('New socket connection:', socket.id);\r\n\r\n  socket.on('user:connect', async (user) => {\r\n    if (!user?._id) {\r\n      console.log('Invalid user ID in user:connect:', user);\r\n      return;\r\n    }\r\n    try {\r\n      onlineUsers.set(user._id, socket.id);\r\n      await User.findByIdAndUpdate(user._id, { online: true });\r\n      io.emit('update:users', Array.from(onlineUsers.keys()));\r\n      console.log('User connected:', user._id, 'Online users:', Array.from(onlineUsers.entries()));\r\n    } catch (err) {\r\n      console.error('Error updating user online status:', err.message || err);\r\n    }\r\n  });\r\n\r\n  socket.on('send:message', async (msg) => {\r\n    console.log('Received message event with data:', msg);\r\n    try {\r\n      if (!msg.sender || !msg.receiver || !msg.text) {\r\n        console.log('Invalid message data:', msg);\r\n        return;\r\n      }\r\n      console.log('Attempting to create message with:', { sender: msg.sender, receiver: msg.receiver, text: msg.text });\r\n      const newMessage = await Message.create({\r\n        sender: mongoose.Types.ObjectId.createFromHexString(msg.sender),\r\n        receiver: mongoose.Types.ObjectId.createFromHexString(msg.receiver),\r\n        text: msg.text,\r\n        timestamp: msg.timestamp || new Date(),\r\n      });\r\n\r\n      const populatedMessage = await Message.findById(newMessage._id)\r\n        .populate('sender', 'username')\r\n        .populate('receiver', 'username');\r\n\r\n      const receiverSocket = onlineUsers.get(msg.receiver);\r\n      if (receiverSocket) {\r\n        io.to(receiverSocket).emit('receive:message', populatedMessage);\r\n        console.log('Message sent to receiver:', receiverSocket);\r\n      }\r\n      io.to(socket.id).emit('receive:message', populatedMessage);\r\n      console.log('Message sent to sender, data:', populatedMessage);\r\n    } catch (err) {\r\n      console.error('Error sending message:', err.message || err);\r\n    }\r\n  });\r\n\r\n  socket.on('disconnect', async () => {\r\n    console.log('Socket disconnecting:', socket.id);\r\n    for (const [userId, sId] of onlineUsers.entries()) {\r\n      if (sId === socket.id) {\r\n        onlineUsers.delete(userId);\r\n        try {\r\n          await User.findByIdAndUpdate(userId, { online: false });\r\n          io.emit('update:users', Array.from(onlineUsers.keys()));\r\n          console.log('User disconnected:', userId, 'Online users:', Array.from(onlineUsers.entries()));\r\n        } catch (err) {\r\n          console.error('Error updating user offline status:', err.message || err);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  });\r\n});\r\n\r\nconst PORT = process.env.PORT || 5000;\r\nserver.listen(PORT, () => console.log(`Server running on port ${PORT}`));"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}